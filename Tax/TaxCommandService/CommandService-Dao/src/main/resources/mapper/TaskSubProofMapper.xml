<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ciicsh.gto.fcbusinesscenter.tax.commandservice.dao.TaskSubProofMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.ciicsh.gto.fcbusinesscenter.tax.entity.po.TaskSubProofPO">
        <id column="id" property="id"/>
        <result column="task_main_proof_id" property="taskMainProofId"/>
        <result column="task_sub_proof_id" property="taskSubProofId"/>
        <result column="task_no" property="taskNo"/>
        <result column="declare_account" property="declareAccount"/>
        <result column="period" property="period"/>
        <result column="headcount" property="headcount"/>
        <result column="chinese_num" property="chineseNum"/>
        <result column="foreigner_num" property="foreignerNum"/>
        <result column="status" property="status"/>
        <result column="is_active" property="isActive"/>
        <result column="created_time" property="createdTime"/>
        <result column="modified_time" property="modifiedTime"/>
        <result column="created_by" property="createdBy"/>
        <result column="modified_by" property="modifiedBy"/>
        <result column="task_type" property="taskType"/>
        <result column="is_combined" property="isCombined"/>
    </resultMap>

    <resultMap id="BaseResultBOMap" type="com.ciicsh.gto.fcbusinesscenter.tax.entity.bo.TaskSubProofBO">
        <id column="id" property="id"/>
        <result column="task_no" property="taskNo"/>
        <result column="manager_no" property="managerNo"/>
        <result column="manager_name" property="managerName"/>
        <result column="declare_account" property="declareAccount"/>
        <result column="period" property="period"/>
        <result column="headcount" property="headcount"/>
        <result column="chinese_num" property="chineseNum"/>
        <result column="foreigner_num" property="foreignerNum"/>
        <result column="status" property="status"/>
        <result column="task_type" property="taskType"/>
        <result column="is_combined" property="isCombined"/>
    </resultMap>

    <!--根据主键ID重新计算子任务总人数-->
    <update id="updateSubHeadcountById">
        update tax_fc_task_sub_proof tsp
        set tsp.headcount = (select count(1) from tax_fc_task_sub_proof_detail spd where spd.is_active = 1 and  spd.task_sub_proof_id = #{id} )
        where  tsp.is_active = 1 and tsp.id = #{id}
    </update>

    <!--多表查询完税凭证子任务-->
    <select id="querySubProofInfoByTaskType" resultMap="BaseResultBOMap"
            parameterType="com.ciicsh.gto.fcbusinesscenter.tax.entity.bo.TaskSubProofBO">
        select tsp.id,
        tsp.task_no,
        tmp.manager_no,
        tmp.manager_name,
        tsp.declare_account,
        tsp.period,
        tsp.headcount,
        tsp.chinese_num,
        tsp.foreigner_num,
        tsp.`status`,
        tsp.task_type,
        tsp.is_combined
        from tax_fc_task_sub_proof tsp
        left join tax_fc_task_main_proof tmp
        on tsp.task_main_proof_id = tmp.id
        where tsp.is_active = 1 <![CDATA[ and tsp.`status` <> '00' and tsp.`status` <> '02' ]]> and tsp.task_sub_proof_id is null
        <if test="managerName != null and managerName != ''">
            and tmp.manager_name LIKE concat('%', #{managerName, jdbcType=VARCHAR},'%')
        </if>
        <if test="declareAccount != null and declareAccount != ''">
            and tsp.declare_account LIKE concat('%', #{declareAccount, jdbcType=VARCHAR},'%')
        </if>
        <if test="period != null">
            and date(tsp.period) = date(#{period,jdbcType=TIMESTAMP})
        </if>
        <if test="status != null and status != ''">
            and tsp.`status` = #{status}
        </if>
        <if test="taskType != null and taskType != ''">
            and tsp.task_type = #{taskType}
        </if>
        order by tsp.created_time desc
    </select>

    <!--根据合并的ID拼接的in条件查询合并前的子任务ID-->
    <select id="querySubIdsByCombinedIds" resultType="java.lang.Long">
      select id from tax_fc_task_sub_proof
      where task_sub_proof_id in (#{sbCombinedParams})
    </select>

    <!--根据主键ID查询完税凭证子任务详细信息-->
    <select id="queryApplyDetailsBySubId" resultMap="BaseResultBOMap">
        select tsp.id,
        tsp.task_no,
        tmp.manager_no,
        tmp.manager_name,
        tsp.declare_account,
        tsp.period,
        tsp.headcount,
        tsp.chinese_num,
        tsp.foreigner_num,
        tsp.`status`,
        tsp.task_type,
        tsp.is_combined
        from tax_fc_task_sub_proof tsp
        left join tax_fc_task_main_proof tmp
        on tsp.task_main_proof_id = tmp.id
        where tsp.is_active = 1 and tsp.id = #{subProofId}
    </select>

    <!--根据主任务ID查询相关人数-->
    <select id="queryPersonNumByMainProofId" resultType="java.util.HashMap">
        select
        sum(headcount) as headNumTotal,
        sum(chinese_num) as chineseNumTotal,
        sum(foreigner_num) as foreignerNumTotal
        from tax_fc_task_sub_proof where task_main_proof_id = #{id}
    </select>

</mapper>
